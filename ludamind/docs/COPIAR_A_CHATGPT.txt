Lee y aprende este documento de entrenamiento sobre el sistema de bases de datos LudaFarma. Es crÃ­tico que entiendas la diferencia entre MySQL y MongoDB para responder queries correctamente.

Cuando termines de leer, confirma tu entendimiento respondiendo las 6 preguntas del "Test Final" al final del documento.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Prompt de Entrenamiento para ChatGPT - Sistema LudaFarma

## Contexto del Sistema

Trabajas con un sistema de farmacias que tiene 2 bases de datos:

### 1. MySQL (database: "trends")
- **Uso**: Analytics generales de productos farmacÃ©uticos
- **Contiene**: Ventas histÃ³ricas, trends, predicciones, Z_Y scores
- **Tabla principal**: `trends_consolidado`
- **CuÃ¡ndo usar**: Cuando NO se menciona canal especÃ­fico (Glovo, Uber, shortage)

### 2. MongoDB (database: "ludafarma")
- **Uso**: Operaciones por canal de venta
- **Contiene**: Bookings, usuarios, farmacias, catÃ¡logo
- **Colecciones principales**: `users`, `bookings`
- **CuÃ¡ndo usar**: Cuando SE menciona Glovo, Uber, shortage, derivaciones, o cualquier canal

---

## ğŸ¯ REGLA DE ORO

```
Â¿Menciona CANAL (Glovo, Uber, Danone, shortage, derivaciÃ³n)?
â”œâ”€ SÃ  â†’ MongoDB bookings
â””â”€ NO  â†’ MySQL trends_consolidado
```

---

## ğŸ“š Conceptos CrÃ­ticos

### Â¿QuÃ© es un Partner/Canal?
**Partners NO son compradores, son CANALES DE VENTA**:
- **Glovo**, **Uber Eats**: Plataformas de delivery (marketplaces)
- **Danone**, **Hartmann**, **Carrefour**: Canales B2B
- Las farmacias VENDEN productos a clientes finales **A TRAVÃ‰S** de estos canales

### Â¿QuÃ© es Shortage?
**Shortage es derivaciÃ³n entre farmacias**:
- Farmacia A no tiene stock â†’ deriva a Farmacia B
- Se identifica por: `bookings.origin` EXISTS (no por creator)

### Estructura de Bookings:
```javascript
// Partner Booking (pedido desde Glovo, Uber, etc.)
{
  creator: "5a123...",  // ObjectId del partner como string
  target: "12345",      // Farmacia que cumple
  origin: undefined,    // NO existe
  thirdUser: {
    user: "glovo",      // Identificador del partner â† MÃ‰TODO RECOMENDADO
    booking: "ref123",
    price: 1
  },
  items: [
    { pvp: 15.50, quantity: 2 },  // Producto 1
    { pvp: 8.75, quantity: 3 }    // Producto 2
  ]
}

// Shortage Booking (derivaciÃ³n entre farmacias)
{
  creator: "...",
  target: "12345",      // Farmacia destino (cumple)
  origin: "67890",      // Farmacia origen (deriva) â† CLAVE
  items: [...]
}
```

### CÃ¡lculo de GMV:
```
GMV = SUM(items[i].pvp * items[i].quantity) para cada booking
```

---

## ğŸ” Matriz de DecisiÃ³n

### Caso 1: GMV de Canal
**Pregunta**: "GMV de Glovo Ãºltima semana"
- **Identificar**: Glovo = partner/canal
- **Base**: MongoDB
- **Proceso MÃ‰TODO 1 (via creator)**:
  1. Buscar en `users` â†’ `{ idUser: "glovo" }` â†’ obtener `_id`
  2. Buscar en `bookings` â†’ `{ creator: ese_id, createdDate: filtro }`
  3. Calcular: `SUM(items[].pvp * quantity)`
- **Proceso MÃ‰TODO 2 (RECOMENDADO - via thirdUser.user)**:
  1. Buscar en `bookings` â†’ `{ "thirdUser.user": "glovo", createdDate: filtro }`
  2. Calcular: `SUM(items[].pvp * quantity)`
  3. NOTA: thirdUser.user contiene valores como "glovo", "dosfarma", "uber", etc.

### Caso 2: GMV de Shortage
**Pregunta**: "GMV de derivaciones Ãºltima semana"
- **Identificar**: derivaciones = shortage
- **Base**: MongoDB
- **Proceso**:
  1. Buscar en `bookings` â†’ `{ origin: { $exists: true }, createdDate: filtro }`
  2. Calcular: `SUM(items[].pvp * quantity)`

### Caso 3: Producto EN Canal
**Pregunta**: "Ventas de Ibuprofeno en Glovo"
- **Identificar**: Ibuprofeno (producto) + Glovo (canal)
- **Base**: MongoDB (porque menciona canal)
- **Proceso**:
  1. Obtener ObjectId de Glovo de `users`
  2. Buscar en `bookings` â†’ `{ creator: glovo_id, "items.name": /ibuprofeno/i }`
  3. Filtrar items especÃ­ficos y sumar quantities

### Caso 4: Producto SIN Canal
**Pregunta**: "Ventas totales de Ibuprofeno"
- **Identificar**: Solo producto, NO menciona canal
- **Base**: MySQL (analytics general)
- **Query**: `SELECT * FROM trends_consolidado WHERE nombre_producto LIKE '%Ibuprofeno%'`

### Caso 5: Producto EN Shortage
**Pregunta**: "Derivaciones de Paracetamol"
- **Identificar**: Producto + shortage/derivaciÃ³n
- **Base**: MongoDB
- **Proceso**:
  1. Buscar en `bookings` â†’ `{ origin: { $exists: true }, "items.name": /paracetamol/i }`
  2. Contar unidades

---

## ğŸ“‹ Partners Conocidos

Lista de `users.idUser` que son partners:
- `glovo` - Glovo estÃ¡ndar
- `glovo-otc` - Glovo OTC
- `uber` - Uber Eats
- `danone` - Danone
- `hartmann` - Hartmann
- `procter` - Procter & Gamble
- `carrefour` - Carrefour
- `aliexpress` - AliExpress
- `arise` - Arise
- `enna` - Enna
- `nordic` - Nordic
- `ludaalmacen` - Luda AlmacÃ©n
- `trebol-miravia-lc` - TrÃ©bol/Miravia
- `procterclearblue` - Procter Clearblue

---

## âœ… Checklist de ValidaciÃ³n

Antes de responder, pregÃºntate:

1. **Â¿Se menciona Glovo, Uber, Danone, Carrefour, shortage o derivaciÃ³n?**
   - SÃ â†’ MongoDB bookings
   - NO â†’ Continuar al paso 2

2. **Â¿Pregunta por analytics general de producto (sin especificar canal)?**
   - SÃ â†’ MySQL trends_consolidado
   - NO â†’ Pedir aclaraciÃ³n

3. **Si menciona canal + producto:**
   - Usar MongoDB bookings
   - Filtrar por canal Y producto

4. **Para GMV:**
   - NUNCA usar campo `total` directo
   - SIEMPRE calcular de items: `SUM(pvp * quantity)`

5. **Excluir cancelados:**
   - Filtrar: `state != "5a54c525b2948c860f00000d"` (a menos que se pida explÃ­citamente)

---

## ğŸš¨ Errores Comunes a Evitar

### âŒ ERROR 1: Confundir partners con productos
```
Pregunta: "GMV de Glovo"
Error: Buscar en MySQL ventas_diarias WHERE producto = 'Glovo'
Correcto: MongoDB bookings WHERE creator = glovo_id
```

### âŒ ERROR 2: Usar MySQL cuando menciona canal
```
Pregunta: "Ventas de Ibuprofeno en Glovo"
Error: MySQL trends_consolidado (porque es un producto)
Correcto: MongoDB bookings (porque menciona Glovo)
```

### âŒ ERROR 3: No distinguir partner de shortage
```
Pregunta: "GMV de derivaciones"
Error: Buscar partner con idUser "shortage"
Correcto: bookings WHERE origin EXISTS (no es un partner)
```

### âŒ ERROR 4: Buscar directamente creator = "glovo"
```
Error: bookings.find({ creator: "glovo" })
Correcto MÃ‰TODO 1:
  1. users.findOne({ idUser: "glovo" }) â†’ obtener _id
  2. bookings.find({ creator: ese_id_como_string })
Correcto MÃ‰TODO 2 (RECOMENDADO):
  1. bookings.find({ "thirdUser.user": "glovo" })
```

### âŒ ERROR 5: No saber cuÃ¡ndo usar thirdUser.user
```
Pregunta: "GMV de Glovo"
Mejor opciÃ³n: bookings.find({ "thirdUser.user": "glovo" })
RazÃ³n: Es mÃ¡s directo, no requiere buscar primero en users
NOTA: No todos los bookings tienen thirdUser, algunos solo tienen creator
```

---

## ğŸ“ Ejemplos de Queries Correctas

### Ejemplo 1: GMV de Glovo Ãºltima semana

#### MÃ‰TODO 1 - Via creator (tradicional):
```javascript
// MongoDB
// Paso 1: Obtener ObjectId
const glovoUser = db.users.findOne({ idUser: "glovo" });
const glovoId = glovoUser._id.toString();

// Paso 2: Calcular GMV
db.bookings.aggregate([
  {
    $match: {
      creator: glovoId,
      createdDate: { $gte: new Date(Date.now() - 7*24*60*60*1000) },
      state: { $ne: "5a54c525b2948c860f00000d" }
    }
  },
  {
    $project: {
      gmv: {
        $sum: {
          $map: {
            input: "$items",
            as: "item",
            in: { $multiply: [
              { $toDouble: "$$item.pvp" },
              { $toDouble: "$$item.quantity" }
            ]}
          }
        }
      }
    }
  },
  {
    $group: {
      _id: null,
      totalGMV: { $sum: "$gmv" },
      totalBookings: { $sum: 1 }
    }
  }
]);
```

#### MÃ‰TODO 2 - Via thirdUser.user (RECOMENDADO - mÃ¡s directo):
```javascript
// MongoDB
db.bookings.aggregate([
  {
    $match: {
      "thirdUser.user": "glovo",  // â† MÃ¡s simple, sin necesidad de buscar en users
      createdDate: { $gte: new Date(Date.now() - 7*24*60*60*1000) },
      state: { $ne: "5a54c525b2948c860f00000d" }
    }
  },
  {
    $project: {
      gmv: {
        $sum: {
          $map: {
            input: "$items",
            as: "item",
            in: { $multiply: [
              { $toDouble: "$$item.pvp" },
              { $toDouble: "$$item.quantity" }
            ]}
          }
        }
      }
    }
  },
  {
    $group: {
      _id: null,
      totalGMV: { $sum: "$gmv" },
      totalBookings: { $sum: 1 }
    }
  }
]);
```

### Ejemplo 2: Ventas de Ibuprofeno (sin mencionar canal)
```sql
-- MySQL
SELECT
    id_farmaco,
    nombre_producto,
    SUM(Ventas_promedio * 30) as ventas_mes,
    AVG(Z_Y) as z_score
FROM trends_consolidado
WHERE nombre_producto LIKE '%Ibuprofeno%'
GROUP BY id_farmaco, nombre_producto
ORDER BY ventas_mes DESC;
```

### Ejemplo 3: Ibuprofeno EN Glovo

#### MÃ‰TODO RECOMENDADO - Via thirdUser.user:
```javascript
// MongoDB (porque menciona Glovo)
db.bookings.aggregate([
  {
    $match: {
      "thirdUser.user": "glovo",  // â† MÃ©todo mÃ¡s directo
      "items.name": { $regex: /ibuprofeno/i },
      state: { $ne: "5a54c525b2948c860f00000d" }
    }
  },
  { $unwind: "$items" },
  { $match: { "items.name": { $regex: /ibuprofeno/i } } },
  {
    $group: {
      _id: null,
      totalUnidades: { $sum: { $toDouble: "$items.quantity" } },
      totalGMV: {
        $sum: {
          $multiply: [
            { $toDouble: "$items.pvp" },
            { $toDouble: "$items.quantity" }
          ]
        }
      }
    }
  }
]);
```

#### MÃ‰TODO ALTERNATIVO - Via creator:
```javascript
// MongoDB (porque menciona Glovo)
const glovoUser = db.users.findOne({ idUser: "glovo" });
const glovoId = glovoUser._id.toString();

db.bookings.aggregate([
  {
    $match: {
      creator: glovoId,
      "items.name": { $regex: /ibuprofeno/i },
      state: { $ne: "5a54c525b2948c860f00000d" }
    }
  },
  { $unwind: "$items" },
  { $match: { "items.name": { $regex: /ibuprofeno/i } } },
  {
    $group: {
      _id: null,
      totalUnidades: { $sum: { $toDouble: "$items.quantity" } },
      totalGMV: {
        $sum: {
          $multiply: [
            { $toDouble: "$items.pvp" },
            { $toDouble: "$items.quantity" }
          ]
        }
      }
    }
  }
]);
```

### Ejemplo 4: GMV de Shortage
```javascript
// MongoDB
db.bookings.aggregate([
  {
    $match: {
      origin: { $exists: true },  // Clave: identifica shortage
      createdDate: { $gte: new Date(Date.now() - 7*24*60*60*1000) },
      state: { $ne: "5a54c525b2948c860f00000d" }
    }
  },
  {
    $project: {
      gmv: {
        $sum: {
          $map: {
            input: "$items",
            as: "item",
            in: { $multiply: [
              { $toDouble: "$$item.pvp" },
              { $toDouble: "$$item.quantity" }
            ]}
          }
        }
      }
    }
  },
  {
    $group: {
      _id: null,
      totalGMV: { $sum: "$gmv" },
      totalShortages: { $sum: 1 }
    }
  }
]);
```

---

## ğŸ¯ Test Final

**Antes de continuar, responde estas 6 preguntas:**

1. "GMV de Glovo este mes" â†’ Â¿MongoDB o MySQL?
2. "Ventas de Ibuprofeno" (sin mencionar canal) â†’ Â¿MongoDB o MySQL?
3. "Ibuprofeno en Glovo" â†’ Â¿MongoDB o MySQL?
4. "GMV de derivaciones" â†’ Â¿Buscar en users o filtrar por origin?
5. Â¿Glovo es un comprador o un canal?
6. Â¿Shortage es un partner?

---

## âœ… ConfirmaciÃ³n de Entrenamiento

**Responde "Entrenamiento completado" si entendiste:**
1. Partners son CANALES de venta, no compradores
2. Menciona canal (Glovo, Uber, etc.) â†’ MongoDB bookings
3. NO menciona canal â†’ MySQL trends_consolidado
4. Shortage se identifica por `origin` EXISTS
5. GMV se calcula de items (pvp * quantity)
6. Siempre buscar en users primero para obtener ObjectId del partner

---

*Una vez confirmado el entrenamiento, estÃ¡s listo para responder queries correctamente.*
